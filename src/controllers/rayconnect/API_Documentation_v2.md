
# RayConnect Multi-Tenant API Documentation v2

## Introduction

Welcome to the RayConnect API. This document provides a comprehensive overview of the API endpoints for our multi-tenant platform. The entire API is built on a multi-tenant architecture, meaning all resources are securely scoped to a specific business.

## Base URL

`http://localhost:5000` (replace with your production URL)

---

## Authentication

The API uses two primary methods of authentication:

1.  **User Authentication (JWT):**
    *   Used for all standard user interactions (admins, agents, etc.).
    *   Obtain a token via the `POST /api/auth/login` endpoint.
    *   The token must be sent in the `Authorization` header as `Bearer <JWT_TOKEN>`.
    *   The decoded JWT contains the `user_id` and `business_id`, which automatically scopes all subsequent API calls to the correct user and business.

2.  **B2B API Token Authentication:**
    *   Used for external B2B integrations (e.g., the Odyssey platform).
    *   Tokens are generated by a business admin via the `POST /api/businesses/api-tokens` endpoint.
    *   The token must be sent in the `Authorization` header as `Bearer <B2B_API_TOKEN>`.

---

## Section 1: Business Management (`/api/businesses`)

Endpoints for creating and managing businesses (tenants).

### 1.1 Create a new Business

Creates a new business and assigns the requesting user as the owner and admin.

- **Endpoint:** `POST /api/businesses`
- **Access:** Authenticated User (via JWT)
- **Request Body:**
  ```json
  {
    "name": "SHS Global Inc."
  }
  ```
- **Success Response (200 OK):**
  ```json
  {
    "msg": "Business created successfully",
    "business_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
  }
  ```
- **Error Response (400 Bad Request):**
  ```json
  {
    "msg": "User is already associated with a business."
  }
  ```

### 1.2 Update Business Credentials

Securely saves/updates the API credentials for third-party services for the business.

- **Endpoint:** `PUT /api/businesses/credentials`
- **Access:** Business Admin
- **Request Body:**
  ```json
  {
    "paystack_secret_key": "sk_test_...",
    "paystack_public_key": "pk_test_...",
    "africastalking_api_key": "key_...",
    "africastalking_username": "myusername",
    "biolite_client_key": "...",
    "biolite_private_key": "...",
    "biolite_public_key": "..."
  }
  ```
- **Success Response (200 OK):**
  ```json
  {
    "msg": "Business credentials updated successfully."
  }
  ```

### 1.3 Generate B2B API Token

Generates a new API token for B2B integrations.

- **Endpoint:** `POST /api/businesses/api-tokens`
- **Access:** Business Admin
- **Request Body:**
  ```json
  {
    "name": "Odyssey Platform Integration"
  }
  ```
- **Success Response (200 OK):**
  ```json
  {
    "msg": "API Token generated successfully. Please store this token securely, it will not be shown again.",
    "token": "e25080c723345c3bbd0095f21a4f9efa808051a99c33a085415258535"
  }
  ```

---

## Section 2: Authentication (`/api/auth`)

### 2.1 Login User

Logs in a user and returns a JWT containing their `id`, `role`, and `business_id`.

- **Endpoint:** `POST /api/auth/login`
- **Access:** Public
- **Request Body:**
  ```json
  {
    "username": "business_admin_user",
    "password": "password123"
  }
  ```
- **Success Response (200 OK):**
  ```json
  {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
        "id": "...",
        "username": "business_admin_user",
        "role": "admin",
        "business_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
    }
  }
  ```

---

## Section 3: User Management

### 3.1 Create/Invite a new User to a Business

Creates a new user (customer, agent, etc.) within the administrator's business.

- **Endpoint:** `POST /api/auth/register`
- **Access:** Business Admin
- **Request Body:**
  ```json
  {
    "username": "new_agent_user",
    "email": "agent@example.com",
    "password": "password123",
    "role": "agent",
    "name": "New Agent"
  }
  ```
- **Success Response (200 OK):**
  ```json
  {
    "msg": "User created successfully",
    "user": {
        "id": "...",
        "username": "new_agent_user",
        "email": "agent@example.com",
        "role": "agent",
        "business_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
    }
  }
  ```

### 3.2 Update User Details

Updates a user's details. A user can update their own details, or an admin can update any user within their business.

- **Endpoint:** `PUT /api/users/:id`
- **Access:** Authenticated User (JWT)
- **Request Body:**
  ```json
  {
    "phone_number": "+1234567890",
    "city": "New York"
  }
  ```
- **Success Response (200 OK):**
  ```json
  {
    "msg": "User updated successfully",
    "user": { ... }
  }
  ```

---

## Section 4: B2B Integrations (`/api/integrations`)

Endpoints designed for programmatic B2B partner access.

### 4.1 Get Payments for Odyssey Platform

Returns a list of payments within a specified time range for the partner's business.

- **Endpoint:** `GET /api/integrations/odyssey/payments`
- **Authentication:** B2B Bearer Token
- **Required Query Parameters:**
    - `FROM`: Start of the date range (ISO 8601: `yyyy-MM-ddTHH:mm:ss.SSSZ`)
    - `TO`: End of the date range (ISO 8601)
- **Optional Query Parameters:**
    - `FINANCING_ID`: An ID specific to the financing program.
- **Example Request:**
  `GET /api/integrations/odyssey/payments?FROM=2022-01-01T00:00:00Z&TO=2022-01-02T00:00:00Z&FINANCING_ID=REA_NEP_OBF`
- **Success Response (200 OK):**
  ```json
  {
    "payments": [
      {
        "timestamp": "2021-05-16T14:16:01.350Z",
        "amount": 5000,
        "currency": "Naira",
        "transactionType": "INSTALLMENT_PAYMENT",
        "serialNumber": "001A-001-1234",
        "customerId": "customer-565",
        "customerName": "Example SHS Customer 1",
        "customerPhone": "+234 0814 731 5678",
        "transactionId": "managepayments.com-transaction-001",
        "financingId": "REA_NEP_OBF",
        "agentId": "managepayments.com-agent-001",
        "latitude": "6.465422",
        "longitude": "3.406448",
        "customerAccountId": "customer-565",
        "utilityId": null,
        "customerCategory": null,
        "failedBatteryCapacityCount": 0,
        "transactionKwh": null
      }
    ]
  }
  ```

---

## Further Sections

*This documentation is a work in progress. Detailed endpoint descriptions for the following sections will be added, but they all follow the same multi-tenant principles as the sections above. All requests are automatically scoped to the authenticated user's business.*

---

## Section 4: Agents (`/api/agents`)

Endpoints for managing and viewing agent data. All requests are scoped to the business of the authenticated user.

### 4.1 List All Agents in Business

Retrieves a list of all agents within the authenticated user's business.

- **Endpoint:** `GET /api/agents`
- **Access:** Business Admin

### 4.2 Get Current Agent's Profile

Retrieves the profile and detailed performance metrics for the currently authenticated agent.

- **Endpoint:** `GET /api/agents/me`
- **Access:** Agent

### 4.3 Get Agent Dashboard Data

Retrieves key performance indicators for the currently authenticated agent's dashboard.

- **Endpoint:** `GET /api/agents/dashboard`
- **Access:** Agent

### 4.4 Get Agent's Customers

Retrieves a list of customers onboarded by the currently authenticated agent.

- **Endpoint:** `GET /api/agents/customers`
- **Access:** Agent

### 4.5 Assign Device to Customer

Assigns an available device to a customer. The device and customer must belong to the same business as the agent.

- **Endpoint:** `POST /api/agents/assign-device`
- **Access:** Agent, Super-Agent, Business Admin
- **Request Body:**
  ```json
  {
    "device_id": "d1e2f3a4-b5c6-7890-1234-567890abcdef",
    "customer_id": "c1d2e3f4-a5b6-7890-1234-567890abcdef"
  }
  ```

### 4.6 Get Agent by ID

Retrieves the profile of a specific agent within the business.

- **Endpoint:** `GET /api/agents/:id`
- **Access:** Business Admin (can view any agent in their business), Agent (can only view their own profile).

### 4.7 Update Agent

Updates the profile of a specific agent. Only admins can update commission rates or status.

- **Endpoint:** `PUT /api/agents/:id`
- **Access:** Business Admin (can update any agent in their business), Agent (can only update their own profile).
- **Request Body:**
  ```json
  {
    "username": "updated_agent_username",
    "email": "updated.agent@example.com",
    "commission_rate": 8.0
  }
  ```

### 4.8 Withdraw Commission

Allows an agent to request a withdrawal from their available commission balance.

- **Endpoint:** `POST /api/agents/withdraw-commission`
- **Access:** Agent, Business Admin
- **Request Body:**
  ```json
  {
    "amount": 500.00,
    "transaction_id": "optional-external-reference-id"
  }
  ```

---

## Section 5: Super-Agents (`/api/super-agents`)

Endpoints for managing super-agents, who can oversee a network of agents within a business.

### 5.1 List All Super-Agents in Business

Retrieves a list of all super-agents within the authenticated user's business.

- **Endpoint:** `GET /api/super-agents`
- **Access:** Business Admin

### 5.2 Get Managed Agents

Retrieves a list of all agents managed by the currently authenticated super-agent.

- **Endpoint:** `GET /api/super-agents/my-agents`
- **Access:** Super-Agent

### 5.3 Get Super-Agent Dashboard

Retrieves key performance indicators for the currently authenticated super-agent's network.

- **Endpoint:** `GET /api/super-agents/dashboard`
- **Access:** Super-Agent

### 5.4 Get Network Customers

Retrieves a list of customers belonging to the agents in the super-agent's network.

- **Endpoint:** `GET /api/super-agents/customers`
- **Access:** Super-Agent

### 5.5 Assign Device to Agent

Assigns one of the super-agent's available devices to one of their managed agents.

- **Endpoint:** `POST /api/super-agents/assign-device`
- **Access:** Super-Agent
- **Request Body:**
  ```json
  {
    "device_id": "d1e2f3a4-b5c6-7890-1234-567890abcdef",
    "agent_id": "a1b2c3d4-e5f6-7890-1234-567890aaaa"
  }
  ```

---

## Section 6: Customers (`/api/customers`)

Endpoints for viewing and managing customer data.

### 6.1 List All Customers in Business

Retrieves a list of all customers within the authenticated user's business.

- **Endpoint:** `GET /api/customers`
- **Access:** Business Admin

### 6.2 Get Current Customer's Profile

Retrieves the profile and detailed history for the currently authenticated customer.

- **Endpoint:** `GET /api/customers/me`
- **Access:** Customer

### 6.3 Get Customer by ID

Retrieves the profile of a specific customer within the business.

- **Endpoint:** `GET /api/customers/:id`
- **Access:** Business Admin, Agent, Super-Agent (can view any customer in their business/network), Customer (can only view their own profile).

### 6.4 Update Customer

Updates the profile of a specific customer.

- **Endpoint:** `PUT /api/customers/:id`
- **Access:** Business Admin, Agent, Super-Agent, Customer (can only update their own profile).
- **Request Body:**
  ```json
  {
    "name": "Updated Customer Name",
    "phone": "+1234567891"
  }
  ```

---

## Section 7: Device Types (`/api/device-types`)

Endpoints for managing the types of devices a business offers, including their pricing models.

### 7.1 Create Device Type

Adds a new type of device to the business's portfolio.

- **Endpoint:** `POST /api/device-types`
- **Access:** Business Admin
- **Request Body:**
  ```json
  {
    "device_name": "Premium Solar Home System",
    "manufacturer": "RayConnect Solar",
    "device_model": "RC-PREMIUM-2025",
    "pricing": {
      "one-time": 50000,
      "12-month": 60000,
      "24-month": 75000
    }
  }
  ```

### 7.2 List Device Types

Retrieves a list of all device types configured for the business.

- **Endpoint:** `GET /api/device-types`
- **Access:** Business Admin, Agent, Super-Agent

### 7.3 Update Device Type

Updates the details of a specific device type.

- **Endpoint:** `PUT /api/device-types/:id`
- **Access:** Business Admin
- **Request Body:**
  ```json
  {
    "device_name": "Premium Solar Home System V2",
    "pricing": {
      "one-time": 55000
    }
  }
  ```

### 7.4 Delete Device Type

Deletes a device type from the business. This may fail if there are existing devices of this type.

- **Endpoint:** `DELETE /api/device-types/:id`
- **Access:** Business Admin

---

## Section 8: Devices (`/api/devices`)

Endpoints for managing the inventory of physical devices.

### 8.1 Add a New Device

Adds a single new device to the business's inventory.

- **Endpoint:** `POST /api/devices`
- **Access:** Business Admin
- **Request Body:**
  ```json
  {
    "serial_number": "SN-987654321",
    "device_type_id": "d1e2f3a4-b5c6-7890-1234-567890abcdef"
  }
  ```

### 8.2 List All Devices

Retrieves a list of all devices belonging to the business, including their status and assignment details.

- **Endpoint:** `GET /api/devices`
- **Access:** Business Admin, Agent, Super-Agent

### 8.3 Approve a Device

Changes a device's status to `available`, making it ready for assignment to a customer.

- **Endpoint:** `PUT /api/devices/:id/approve`
- **Access:** Business Admin

### 8.4 Bulk Upload Devices via Excel

Allows for adding multiple devices at once by uploading an Excel file.
The Excel file should have columns named `serial_number` and `device_type_id`.

- **Endpoint:** `POST /api/devices/upload-excel`
- **Access:** Business Admin
- **Request Type:** `multipart/form-data`
- **Form Field:** `excelFile` (the .xlsx or .xls file)

---

## Section 9: Deals (`/api/deals`)

Endpoints for creating and managing special deals or promotions for specific device types.

### 9.1 Create a Deal

Creates a new deal for a specific device type within the business.

- **Endpoint:** `POST /api/deals`
- **Access:** Business Admin
- **Request Body:**
  ```json
  {
    "deal_name": "Summer Sale 2025",
    "device_type_id": "d1e2f3a4-b5c6-7890-1234-567890abcdef",
    "allowed_payment_frequencies": ["daily", "weekly"],
    "start_date": "2025-06-01",
    "end_date": "2025-09-01"
  }
  ```

### 9.2 List All Deals

Retrieves a list of all deals configured for the business.

- **Endpoint:** `GET /api/deals`
- **Access:** Business Admin

### 9.3 Get Deal by ID

Retrieves the details of a specific deal.

- **Endpoint:** `GET /api/deals/:id`
- **Access:** Business Admin

### 9.4 Update a Deal

Updates the details of an existing deal.

- **Endpoint:** `PUT /api/deals/:id`
- **Access:** Business Admin
- **Request Body:**
  ```json
  {
    "deal_name": "Extended Summer Sale 2025",
    "end_date": "2025-09-15"
  }
  ```

### 9.5 Delete a Deal

Deletes a deal from the business.

- **Endpoint:** `DELETE /api/deals/:id`
- **Access:** Business Admin

---

## Section 10: Loans (`/api/loans`)

Endpoints for creating and managing customer loans for device purchases.

### 10.1 Create a Loan

Creates a new loan for a customer, linking them to a specific device. This action also assigns the device to the customer.

- **Endpoint:** `POST /api/loans`
- **Access:** Business Admin, Agent, Super-Agent
- **Request Body:**
  ```json
  {
    "customer_id": "c1d2e3f4-a5b6-7890-1234-567890abcdef",
    "device_id": "d1e2f3a4-b5c6-7890-1234-567890abcdef",
    "term_months": 12,
    "down_payment": 50.00,
    "payment_frequency": "monthly",
    "guarantor_details": {
      "name": "Guarantor Name",
      "phone": "+1234567890"
    }
  }
  ```

### 10.2 List All Loans

Retrieves a list of all loans within the business.

- **Endpoint:** `GET /api/loans`
- **Access:** Business Admin

### 10.3 Get Loan by ID

Retrieves the full details of a specific loan.

- **Endpoint:** `GET /api/loans/:id`
- **Access:** Business Admin, Agent, Super-Agent, Customer (own loan only)

### 10.4 Get Loans by Customer

Retrieves all loans associated with a specific customer ID.

- **Endpoint:** `GET /api/loans/customer/:customerId`
- **Access:** Business Admin, Agent, Super-Agent, Customer (own loans only)

### 10.5 Update a Loan

Updates the details of an existing loan.

- **Endpoint:** `PUT /api/loans/:id`
- **Access:** Business Admin, Agent, Super-Agent
- **Request Body:**
  ```json
  {
    "status": "defaulted",
    "guarantor_details": { ... }
  }
  ```

### 10.6 Approve a Loan

Changes a loan's status from `pending` to `active`.

- **Endpoint:** `PUT /api/loans/:id/approve`
- **Access:** Business Admin

---

## Section 11: Payments (`/api/payments`)

Endpoints for handling and recording payments.

### 11.1 List All Payments

Retrieves a list of all payments recorded for the business.

- **Endpoint:** `GET /api/payments`
- **Access:** Business Admin

### 11.2 Record a Manual Payment

Manually records a payment (e.g., cash) against a loan.

- **Endpoint:** `POST /api/payments/manual`
- **Access:** Business Admin, Agent, Super-Agent
- **Request Body:**
  ```json
  {
    "loan_id": "l1o2a3n4-e5x6-7890-1234-567890abcdef",
    "user_id": "c1d2e3f4-a5b6-7890-1234-567890abcdef",
    "amount": 50.00,
    "currency": "NGN",
    "payment_method": "cash"
  }
  ```

### 11.3 Pay with Agent Credit

Allows an agent or super-agent to make a payment on behalf of a customer using their own credit balance.

- **Endpoint:** `POST /api/payments/agent-credit`
- **Access:** Agent, Super-Agent, Business Admin
- **Request Body:**
  ```json
  {
    "loan_id": "l1o2a3n4-e5x6-7890-1234-567890abcdef",
    "user_id": "c1d2e3f4-a5b6-7890-1234-567890abcdef",
    "amount": 50.00
  }
  ```

### 11.4 Initiate Paystack Payment

Initiates a payment transaction using the business's configured Paystack credentials.

- **Endpoint:** `POST /api/payments/paystack/initiate`
- **Access:** Customer, Agent, Super-Agent
- **Request Body:**
  ```json
  {
    "amount": 5000,
    "reference": "your-unique-reference-for-this-transaction",
    "metadata": {
        "loan_id": "l1o2a3n4-e5x6-7890-1234-567890abcdef",
        "user_id": "c1d2e3f4-a5b6-7890-1234-567890abcdef"
    }
  }
  ```

### 11.5 Paystack Webhook

An endpoint for Paystack to send server-to-server notifications about payment events. This endpoint is used by Paystack, not by clients directly.

- **Endpoint:** `POST /api/payments/paystack/webhook`
- **Access:** Public

---

## Section 12: Analytics (`/api/analytics`)

Endpoints for retrieving aggregated data and performance metrics for the business.

### 12.1 Get Business Overview

Provides key performance indicators for the entire business, such as total payments, active loans, and device counts.

- **Endpoint:** `GET /api/analytics/overview`
- **Access:** Business Admin

### 12.2 Get Agent Performance Metrics

Retrieves performance metrics for all agents within the business, including commissions earned and devices assigned.

- **Endpoint:** `GET /api/analytics/agent-performance`
- **Access:** Business Admin

---

## Section 13: Platform Management (`/api/platform`)

Endpoints for the overall Platform Owner to manage all tenant businesses.

**Note:** Access to these endpoints requires the special `platform_owner` role.

### 13.1 List All Businesses

Retrieves a list of all businesses on the platform, including their status and subscription details.

- **Endpoint:** `GET /api/platform/businesses`
- **Access:** Platform Owner

### 13.2 Get Business by ID
Retrieves the full details for a single business on the platform, including its B2B API tokens.

- **Endpoint:** `GET /api/platform/businesses/:id`
- **Access:** Platform Owner
- **Success Response (200 OK):**
  ```json
  {
    "id": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
    "name": "SHS Global Inc.",
    "owner_id": "user-uuid-123",
    "created_at": "2025-08-01T12:00:00.000Z",
    "updated_at": "2025-08-25T18:00:00.000Z",
    "status": "active",
    "subscription_plan": "yearly",
    "subscription_status": "active",
    "subscription_start_date": "2025-08-01T00:00:00.000Z",
    "subscription_end_date": "2026-08-01T00:00:00.000Z",
    "stripe_customer_id": "cus_12345",
    "api_tokens": [
      {
        "id": "token-uuid-1234",
        "name": "Odyssey Platform Integration",
        "created_at": "2025-08-30T10:00:00.000Z",
        "last_used_at": "2025-08-30T11:30:00.000Z"
      }
    ]
  }
  ```

### 13.3 Update Business Details

Updates a business's general information, such as its name or status (`active`, `suspended`).

- **Endpoint:** `PUT /api/platform/businesses/:id`
- **Access:** Platform Owner
- **Request Body:**
  ```json
  {
    "name": "Business New Name",
    "status": "suspended"
  }
  ```

### 13.4 Update Business Subscription

Updates a business's subscription details. Useful for manual subscription management.

- **Endpoint:** `PUT /api/platform/businesses/:id/subscription`
- **Access:** Platform Owner
- **Request Body:**
  ```json
  {
    "subscription_plan": "yearly",
    "subscription_status": "active",
    "subscription_end_date": "2026-12-31T23:59:59Z"
  }
  ```

### 13.5 Get B2B API Tokens for a Business
Retrieves a list of all B2B API tokens for a specific business. Note: This does not return the tokens themselves, only their metadata.

- **Endpoint:** `GET /api/platform/businesses/:id/api-tokens`
- **Access:** Platform Owner
- **URL Parameters:**
  - `id`: The UUID of the business.
- **Success Response (200 OK):**
  ```json
  [
    {
      "id": "token-uuid-1234",
      "name": "Odyssey Platform Integration",
      "created_at": "2025-08-30T10:00:00.000Z",
      "last_used_at": "2025-08-30T11:30:00.000Z"
    }
  ]
  ```
- **Error Response (404 Not Found):**
  ```json
  {
    "msg": "Business not found."
  }
  ```

### 13.6 Get Platform Analytics Overview
Retrieves high-level, platform-wide analytics including business counts, subscription statuses, total revenue, and recently registered businesses.

- **Endpoint:** `GET /api/platform/analytics/businesses`
- **Access:** Platform Owner
- **Success Response (200 OK):**
  ```json
  {
    "total_businesses": 50,
    "total_subscriptions": 48,
    "total_active_subscriptions": 45,
    "total_revenue": 250000.75,
    "recently_registered_businesses": [
      {
        "id": "f1e2d3c4-b5a6-7890-1234-567890abcdef",
        "name": "Latest Solar Co",
        "owner_id": "user-uuid-latest",
        "created_at": "2025-08-31T10:00:00.000Z",
        "status": "active"
      },
      {
        "id": "e1d2c3b4-a5b6-7890-1234-567890abcdef",
        "name": "NextGen Energy",
        "owner_id": "user-uuid-nextgen",
        "created_at": "2025-08-30T15:30:00.000Z",
        "status": "active"
      }
    ]
  }
  ```

### 13.7 Get Analytics for a Single Business
Retrieves key performance analytics for a specific business on the platform.

- **Endpoint:** `GET /api/platform/analytics/businesses/:id`
- **Access:** Platform Owner
- **URL Parameters:**
  - `id`: The UUID of the business.
- **Success Response (200 OK):**
  ```json
    {
      "business_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
      "total_payments": 15000.00,
      "total_loans": 150,
      "active_loans": 120,
      "total_customers": 500,
      "total_agents": 20,
      "total_devices": 300,
      "assigned_devices": 250,
      "available_devices": 50
    }
  ```
- **Error Response (404 Not Found):**
  ```json
  {
    "msg": "Business not found."
  }
  ```

---

## Section 14: Admin Operations (`/api/admin`)

Admin-specific operations for managing business resources.

### 14.1 Reprocess a Device

Resets a device's status to 'available' and un-assigns it from any customer or agent, making it available for a new loan. This action is logged for auditing purposes and requires a reason. It will fail if the device is currently linked to an active loan.

- **Endpoint:** `PUT /api/admin/devices/:id/reprocess`
- **Access:** Business Admin
- **URL Parameters:**
  - `id`: The UUID of the device to reprocess.
- **Request Body:**
  ```json
  {
    "reason": "End of Loan",
    "notes": "Device returned in good condition."
  }
  ```
- **Success Response (200 OK):**
  ```json
  {
    "msg": "Device has been successfully reprocessed and is now available.",
    "device": {
      "id": "d1e2f3a4-b5c6-7890-1234-567890abcdef",
      "serial_number": "DEV-001",
      "status": "available",
      "assigned_to": null,
      "assigned_by": null,
      "super_agent_id": null,
      "install_date": null,
      "updated_at": "2025-09-01T14:00:00.000Z"
    }
  }
  ```
- **Error Response (400 Bad Request):**
  ```json
  {
    "msg": "A reason for reprocessing is required."
  }
  ```
  ```json
  {
    "msg": "Device cannot be reprocessed. It is still tied to an active loan.",
    "loan_id": "l1o2a3n4-e5x6-7890-1234-567890abcdef"
  }
  ```
- **Error Response (404 Not Found):**
  ```json
  {
    "msg": "Device not found in your business."
  }
  ```

### 14.2 Get Device History

Retrieves the full audit history for a specific device, showing all status changes and reprocessing events.

- **Endpoint:** `GET /api/admin/devices/:id/history`
- **Access:** Business Admin
- **URL Parameters:**
  - `id`: The UUID of the device.
- **Success Response (200 OK):**
  ```json
  [
    {
      "id": "hist-uuid-1",
      "device_id": "d1e2f3a4-b5c6-7890-1234-567890abcdef",
      "business_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
      "changed_by": "admin-user-uuid",
      "changed_by_username": "admin_user",
      "previous_status": "assigned",
      "new_status": "available",
      "reason": "End of Loan",
      "notes": "Device returned in good condition.",
      "created_at": "2025-09-01T14:00:00.000Z"
    }
  ]
  ```

### 14.3 Approve or Reject Agent Request
- **Endpoint:** `PUT /api/admin/agents/:id/approval`
- **Access:** Business Admin
- **URL Parameters:**
  - `id`: The UUID of the agent to approve or reject.
- **Request Body:**
  ```json
  {
    "status": "active", 
    "reason": "Optional reason for rejection"
  }
  ```
- **Success Response (200 OK):**
  ```json
  {
    "msg": "Agent request active.",
    "agent": {
      "id": "...",
      "username": "new_agent_user",
      "email": "agent@example.com",
      "role": "agent",
      "status": "active"
    }
  }
  ```
- **Error Response (400 Bad Request):**
  ```json
  {
    "msg": "Invalid status. Must be 'active' or 'rejected'."
  }
  ```
  ```json
  {
    "msg": "A reason is required for rejection."
  }
  ```
- **Error Response (404 Not Found):**
  ```json
  {
    "msg": "Agent not found in your business."
  }
  ```

